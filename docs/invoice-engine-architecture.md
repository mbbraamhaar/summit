# Invoice Engine Architecture

## Purpose

This document defines a shared invoice engine architecture for two invoice domains:  
1) Summit subscription invoices, and 2) future customer invoices generated by users.  
It is authoritative for normalized invoice document shape, adapter boundaries, and renderer responsibilities.

## Canonical Rules

- Summit will use one invoice engine target for both subscription and customer invoice outputs.
- Domain-specific data is translated through adapters into a normalized `InvoiceDocument` shape.
- Rendering is output-focused: PDF now, UBL later.
- Source-domain tables stay decoupled from rendering and formatting concerns.

## Normalized `InvoiceDocument` Concept

Required normalized fields (conceptual, no code):
- `document_type` (subscription_invoice | customer_invoice)
- `invoice_number`
- `issue_date`
- `period_start`
- `period_end`
- `seller` object (legal name, registration id, tax id, address, country, bank/payment identity)
- `buyer` object (legal name, registration id, tax id, address, country)
- `currency`
- `line_items[]` (description, quantity, unit, unit_price, tax_rate, tax_amount, line_total)
- `subtotal_amount`
- `tax_total_amount`
- `total_amount`
- `tax_treatment` (for example NL VAT / EU reverse-charge / non-EU B2B)
- `payment_terms`
- `payment_reference`
- `metadata` (source IDs, external provider references)

## Adapter Model

### `SubscriptionInvoiceAdapter`
Data sources:
- Company billing identity (`companies` fields)
- Subscription and plan period/pricing (`subscriptions`, `plans`)
- Payment-confirmation event context (provider lifecycle events)

Responsibility:
- Build normalized `InvoiceDocument` from subscription payment events.

### `CustomerInvoiceAdapter` (Planned)
Data sources (future):
- User-domain invoice entities (for example `invoices`, `clients`, related line items/payments)

Responsibility:
- Build normalized `InvoiceDocument` from customer invoice domain data.

## Renderer Responsibilities

- Accept normalized `InvoiceDocument` input.
- Produce PDF output in v1.
- Produce UBL output in later phase.
- Keep rendering concerns separate from tax-policy decisions and source-domain reads.

## Immutability and Snapshots

- Generated invoices are immutable snapshots; once issued, they must not change if source-domain data changes.
- Each generated invoice must store the full normalized `InvoiceDocument` snapshot used for rendering, with reference IDs stored separately.

## Invoice Numbering Strategy

Current decisions:
- Customer invoices: numbering is per company.
- Summit seller subscription invoices: intended to be seller-entity scoped, likely global per legal seller entity.

Open decision:
- Confirm final numbering policy for Summit seller invoices (global vs segmented sequences by jurisdiction/entity).

## Required B2B Invoice Fields Checklist

Minimum checklist:
- Seller legal entity name
- Seller registration ID
- Seller tax ID (where applicable)
- Seller address and country
- Buyer legal entity name
- Buyer registration ID (where applicable)
- Buyer tax ID (where applicable)
- Buyer address and country
- Invoice number
- Invoice issue date
- Subscription or service period (start/end)
- Currency
- Line item details
- Subtotal, tax amount, and grand total
- Reverse-charge notation when applicable

## Data Dependencies

See `docs/database-schema.md` for canonical schema details.

Current concrete dependencies:
- `companies` billing/tax identity fields
- `subscriptions` lifecycle and period fields
- `plans` pricing interval metadata

Planned dependencies:
- Future customer invoicing tables (not yet implemented in schema)

## Open Questions / Planned Work

Planned:
- Define UBL schema mapping from normalized `InvoiceDocument`.
- Define storage strategy for generated invoice artifacts and immutable snapshots.
- Define credit-note/reversal document strategy.

Open questions:
- Final Summit seller numbering policy and sequence ownership.
- Whether to include event-log provenance fields as mandatory in normalized document metadata.
